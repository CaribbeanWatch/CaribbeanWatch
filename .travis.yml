
# - NAME=Xenial-16.04-docker
env:
  global:
    TRAVIS_JOB_NUMBER=$TRAVIS_JOB_NUMBER

stages:
  - build
  - generate
  - deploy

jobs:
  include:
    stage: build
    name: "Build"
    services:
    - docker
    dist: xenial
    language: cpp
    before_install:
    - openssl aes-256-cbc -K $encrypted_149a08f8ff66_key -iv $encrypted_149a08f8ff66_iv -in store.tar.enc -out store.tar -d
    - tar xvf store.tar
    install:
    - docker build -t caribbeanwatch -f Dockerfile --build-arg TRAVIS_JOB_NUMBER="$TRAVIS_JOB_NUMBER" .

    stage: generate
    name: 'Generate caribbean_basin-daily'
    services:
    - docker
    dist: xenial
    language: cpp
    before_install:
    - openssl aes-256-cbc -K $encrypted_149a08f8ff66_key -iv $encrypted_149a08f8ff66_iv -in store.tar.enc -out store.tar -d
    - tar xvf store.tar
    install:
    - docker build -t caribbeanwatch -f Dockerfile --build-arg TRAVIS_JOB_NUMBER="$TRAVIS_JOB_NUMBER" .
    script:
    - docker run -v $PWD:/run -w="/run" -a stdout -t caribbeanwatch /home/caribbeanwatch/src/pyRVPelagia64PE414Sababank_Current/mercator/update.py -j $TRAVIS_JOB_NUMBER --daily -r caribbean_basin

    stage: deploy
    - env:
    - NAME=web-build
    services:
    - docker
    dist: xenial
    language: cpp
    before_install:
    - openssl aes-256-cbc -K $encrypted_149a08f8ff66_key -iv $encrypted_149a08f8ff66_iv -in store.tar.enc -out store.tar -d
    - tar xvf store.tar
    install:
    - docker build -t webpages -f Dockerfile_webupdate --build-arg TRAVIS_JOB_NUMBER="$TRAVIS_JOB_NUMBER" .
    script:
    - docker run -a stdout -t webpages ./update.sh "Automatic update to static site from travis CaribbeanWatch, jobid $TRAVIS_JOB_NUMBER"
    
    #- docker run -a stdout -t webpages bundler exec jekyll build
    #- docker run -a stdout -t webpages touch docs/.nojekyll
    ##- docker run -a stdout -t webpages git pull
    #- docker run -a stdout -t webpages git add -A docs/
    #- docker run -a stdout -t webpages git commit -a -m "Automatic update to static site from travis (updater), jobid $TRAVIS_JOB_NUMBER"
    #- docker run -a stdout -t webpages git push
    #- docker run -a stdout -t webpages git rev-parse HEAD~1 .

